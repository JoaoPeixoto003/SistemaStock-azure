<!doctype html>
<html lang="pt">

<head>
  <meta charset="UTF-8">
  <title>Invent√°rio</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 font-sans min-h-screen">

  <header class="bg-blue-600 text-white p-4 shadow flex justify-between items-center">
    <h1 class="text-xl font-bold">üì¶ Sistema de Invent√°rio</h1>
    <div class="flex gap-4 items-center">
      <div id="user-info" class="italic"></div>
      <button id="logout-btn" onclick="logout()"
        class="hidden bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded">
        Sair
      </button>
    </div>
  </header>

  <main class="p-6 space-y-6">

    <!-- Login -->
    <section id="login-section" class="bg-white p-6 rounded shadow">
      <h2 class="text-lg font-bold mb-4">Login</h2>
      <div class="flex gap-4 flex-wrap">
        <input id="username" class="border p-2 rounded" placeholder="Utilizador">
        <input id="password" type="password" class="border p-2 rounded" placeholder="Password">
        <button onclick="login()" class="bg-green-600 text-white px-4 py-2 rounded">Entrar</button>
      </div>
    </section>

    <!-- App -->
    <section id="app-section" class="hidden space-y-6">

      <!-- M√©tricas -->
      <section class="grid grid-cols-1 md:grid-cols-4 gap-6">
        <div class="bg-white p-4 rounded shadow text-center">
          <h2 class="text-gray-500">Total Produtos</h2>
          <p id="m-total" class="text-3xl font-bold">‚Äî</p>
        </div>
        <div class="bg-white p-4 rounded shadow text-center">
          <h2 class="text-gray-500">Stock Baixo</h2>
          <p id="m-low" class="text-3xl font-bold text-red-600">‚Äî</p>
        </div>
        <div class="bg-white p-4 rounded shadow text-center">
          <h2 class="text-gray-500">Movimentos Hoje</h2>
          <p id="m-mov" class="text-3xl font-bold text-green-600">‚Äî</p>
        </div>
        <div class="bg-white p-4 rounded shadow text-center">
          <h2 class="text-gray-500">Alertas</h2>
          <p id="m-alerts" class="text-3xl font-bold text-yellow-600">‚Äî</p>
        </div>
      </section>

      <!-- Adicionar Produto -->
      <section class="bg-white p-6 rounded shadow space-y-4">
        <h2 class="text-lg font-bold mb-4">Adicionar Produto</h2>
        <div class="flex gap-4 flex-wrap">
          <input id="p-nome" class="border p-2 rounded flex-1" placeholder="Nome">
          <input id="p-cat" class="border p-2 rounded flex-1" placeholder="Categoria">
          <input id="p-qtd" class="border p-2 rounded w-24" type="number" placeholder="Qtd">
          <input id="p-min" class="border p-2 rounded w-24" type="number" placeholder="M√≠n">
          <button onclick="addProduto()" class="bg-blue-600 text-white px-4 py-2 rounded">Adicionar</button>
        </div>

        <div class="flex gap-2 items-center">
          <input type="file" id="p-img" accept="image/*">
          <button id="btn-upload" onclick="uploadSelectedImage()"
            class="bg-purple-600 text-white px-4 py-2 rounded">Upload Imagem</button>
          <span id="upload-status" class="text-sm italic"></span>
        </div>

      </section>

      <!-- Lista Produtos -->
      <section class="bg-white p-6 rounded shadow">
        <h2 class="text-lg font-bold mb-4">Produtos</h2>
        <table class="w-full border-collapse">
          <thead>
            <tr class="bg-gray-200">
              <th class="p-2 border">Nome</th>
              <th class="p-2 border">Categoria</th>
              <th class="p-2 border">Qtd</th>
              <th class="p-2 border">M√≠n</th>
              <th class="p-2 border">Imagem</th>
              <th class="p-2 border">A√ß√µes</th>
            </tr>
          </thead>
          <tbody id="t-prod"></tbody>
        </table>
      </section>

      <!-- Lista Movimenta√ß√µes -->
      <section class="bg-white p-6 rounded shadow">
        <h2 class="text-lg font-bold mb-4">Movimenta√ß√µes</h2>
        <table class="w-full border-collapse">
          <thead>
            <tr class="bg-gray-200">
              <th class="p-2 border">Tipo</th>
              <th class="p-2 border">Produto</th>
              <th class="p-2 border">Qtd</th>
              <th class="p-2 border">Utilizador</th>
              <th class="p-2 border">Data</th>
            </tr>
          </thead>
          <tbody id="t-mov"></tbody>
        </table>
      </section>

    </section>
  </main>

  <script>
    const API = window.location.hostname.includes("azurestaticapps.net")
      ? "https://inventory-backend-joao-h9duehb0hbeehcay.westeurope-01.azurewebsites.net/"
      : "http://localhost:8080";

    let token = localStorage.getItem("token") || null;
    let lastUploadedImageUrl = null;
    let produtosCache = {}; // map id -> produto

    function showApp(logged) {
      document.getElementById("login-section").classList.toggle("hidden", logged);
      document.getElementById("app-section").classList.toggle("hidden", !logged);
      document.getElementById("logout-btn").classList.toggle("hidden", !logged);
      if (logged) {
        document.getElementById("user-info").textContent = "Autenticado";
        carregar();
        carregarMovimentacoes();
      } else {
        document.getElementById("user-info").textContent = "";
      }
    }

    async function login() {
      const res = await fetch(API + "/api/auth/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          username: document.getElementById("username").value,
          password: document.getElementById("password").value
        })
      });
      if (res.ok) {
        const data = await res.json();
        token = data.token;
        localStorage.setItem("token", token);
        showApp(true);
      } else alert("Credenciais inv√°lidas");
    }

    function logout() {
      token = null;
      localStorage.removeItem("token");
      showApp(false);
    }

    async function fetchJSON(url, opts = {}) {
      opts.headers = opts.headers || {};
      if (token) opts.headers["Authorization"] = "Bearer " + token;
      const r = await fetch(url, opts);
      if (!r.ok) throw new Error(await r.text());
      return r.json();
    }

    // Produtos
    async function carregar() {
      const produtos = await fetchJSON(API + "/api/produtos");
      produtosCache = {};
      produtos.forEach(p => produtosCache[p.id] = p);

      document.getElementById("t-prod").innerHTML = produtos.map(p => `
  <tr>
    <td class="p-2 border">${p.nome}</td>
    <td class="p-2 border">${p.categoria}</td>
    <td class="p-2 border ${p.quantidadeAtual <= p.quantidadeMinima ? 'text-red-600 font-bold' : ''}">
      ${p.quantidadeAtual || 0}
    </td>
    <td class="p-2 border">${p.quantidadeMinima || 0}</td>
    <td class="p-2 border">${p.imagemUrl ? `<img src="${p.imagemUrl}" class="w-20 h-12 object-cover rounded">` : '‚Äî'}</td>
    <td class="p-2 border flex gap-2">
      <button onclick="alterarQuantidade('${p.id}','${p.categoria}',1)" class="bg-green-600 text-white px-2 py-1 rounded">‚ûï</button>
      <button onclick="alterarQuantidade('${p.id}','${p.categoria}',-1)" class="bg-yellow-600 text-white px-2 py-1 rounded">‚ûñ</button>
      <button onclick="apagarProduto('${p.id}', '${p.categoria}')" class="bg-red-600 text-white px-2 py-1 rounded">üóëÔ∏è</button>
    </td>
  </tr>`).join("");

      document.getElementById("m-total").textContent = produtos.length;
      document.getElementById("m-low").textContent = produtos.filter(p => (p.quantidadeAtual || 0) <= (p.quantidadeMinima || 0)).length;
    }

    // Add product (uses lastUploadedImageUrl if set)
    async function addProduto() {
      const payload = {
        nome: document.getElementById("p-nome").value,
        categoria: document.getElementById("p-cat").value || "Geral",
        quantidadeAtual: Number(document.getElementById("p-qtd").value || 0),
        quantidadeMinima: Number(document.getElementById("p-min").value || 0),
        imagemUrl: lastUploadedImageUrl || null
      };
      await fetchJSON(API + "/api/produtos", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      // reset image state
      lastUploadedImageUrl = null;
      document.getElementById("p-img").value = "";
      document.getElementById("upload-status").textContent = "";
      carregar();
      carregarMovimentacoes();
    }

    async function apagarProduto(id, categoria) {
      if (!confirm("Tens a certeza que queres apagar este produto?")) return;
      await fetchJSON(`${API}/api/produtos/${id}/${categoria}`, { method: "DELETE" });
      carregar();
      carregarMovimentacoes();
    }

    // Alterar quantidade
    async function alterarQuantidade(id, categoria, delta) {
      try {
        await fetchJSON(`${API}/api/produtos/${id}/${categoria}/quantidade`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ delta })
        });
        location.reload(); // refresh automatic
      } catch (err) {
        console.error("Erro ao alterar quantidade:", err);
        alert("Erro ao alterar quantidade");
      }
    }

    // Movimentacoes (show product name instead of id)
    async function carregarMovimentacoes() {
      try {
        // ensure products cache
        if (!Object.keys(produtosCache).length) {
          await carregar();
        }
        const movs = await fetchJSON(API + "/api/produtos/movimentacoes/all");
        document.getElementById("t-mov").innerHTML = movs.map(m => `
    <tr>
      <td class="p-2 border">${m.tipo}</td>
      <td class="p-2 border">${(produtosCache[m.produtoId] && produtosCache[m.produtoId].nome) || m.produtoId}</td>
      <td class="p-2 border">${m.quantidade}</td>
      <td class="p-2 border">${m.user}</td>
      <td class="p-2 border">${new Date(m.data).toLocaleString()}</td>
    </tr>`).join("");

        const hoje = new Date().toISOString().slice(0, 10);
        const hojeCount = movs.filter(m => m.data.startsWith(hoje)).length;
        document.getElementById("m-mov").textContent = hojeCount;
      } catch (e) {
        console.error("Erro ao carregar movimenta√ß√µes:", e);
      }
    }

    // Upload image and store URL in lastUploadedImageUrl
    async function uploadSelectedImage() {
      const fileInput = document.getElementById("p-img");
      if (fileInput.files.length === 0) return alert("Seleciona uma imagem primeiro");
      const file = fileInput.files[0];
      const reader = new FileReader();
      reader.onload = async () => {
        const base64 = reader.result.split(",")[1];
        const payload = { filename: file.name, dataBase64: base64 };
        try {
          document.getElementById("upload-status").textContent = "A enviar...";
          const res = await fetchJSON(API + "/api/produtos/upload", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });
          lastUploadedImageUrl = res.url;
          document.getElementById("upload-status").textContent = "Imagem carregada ‚úîÔ∏è";
        } catch (e) {
          console.error(e);
          document.getElementById("upload-status").textContent = "Erro no upload";
          alert("Erro ao enviar imagem");
        }
      };
      reader.readAsDataURL(file);
    }

    showApp(!!token);
  </script>
</body>

</html>